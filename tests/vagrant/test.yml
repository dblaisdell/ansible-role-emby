---

- name: Test emby role
  hosts: all
  remote_user: root

  pre_tasks:
    - name: Update apt
      become: yes
      apt:
        cache_valid_time: 1800
        update_cache: yes
      tags:
        - build

  vars:
      emby_user: test-emby
      emby_group: test-root

  roles:
    - role: rofrantz.emby
      tags:
        - build
        - emby

  post_tasks:
    - name: Check if {{ emby_service }} is running
      command: systemctl status {{ emby_service }}
      ignore_errors: yes
      changed_when: false
      register: service_status
      tags:
        - assert

    - name: Report status of {{ emby_service }}
      fail:
        msg: |
          Service {{ emby_service }} is not running.
          Output of `systemctl status {{ emby_service }}`:
          {{ service_status.stdout }}
          {{ service_status.stderr }}
      when: service_status | failed
      tags:
        - assert
